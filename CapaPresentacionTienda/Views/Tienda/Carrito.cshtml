@{
    ViewBag.Title = "Carrito";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Agregamos el link correcto de Font Awesome sin integrity -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer" />

<div class="container my-5">
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body">

                    <!-- Encabezado -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="ms-2 mt-2">Detalle Carrito</h5>
                        <a class="btn btn-primary" href="@Url.Action("Index","Tienda")">
                            <i class="fas fa-cart-plus"></i> Seguir Comprando
                        </a>
                    </div>

                    <hr class="mt-2 mb-4" />

                    <div class="row">
                        <!-- Columna izquierda: Productos -->
                        <div class="col-sm-9">
                            <div id="productos-carrito"></div>

                            <div class="d-flex justify-content-end mt-3">
                                <label class="align-self-center">
                                    <b>Total: USD <span id="total">0.00</span></b>
                                </label>
                            </div>
                        </div>

                        <!-- Columna derecha: Detalle Envío -->
                        <div class="col-sm-3">
                            <div class="card h-100">
                                <div class="card-body bg-light">
                                    <h5 class="card-title text-center mb-3">Detalle Envío</h5>

                                    <form>
                                        <div class="mb-2">
                                            <label for="cbodepartamento" class="form-label">Departamento:</label>
                                            <select class="form-select form-select-sm" id="cbodepartamento"></select>
                                        </div>

                                        <div class="mb-2">
                                            <label for="cboprovincia" class="form-label">Provincia:</label>
                                            <select class="form-select form-select-sm" id="cboprovincia"></select>
                                        </div>

                                        <div class="mb-2">
                                            <label for="cbodistrito" class="form-label">Distrito:</label>
                                            <select class="form-select form-select-sm" id="cbodistrito"></select>
                                        </div>

                                        <div class="mb-2">
                                            <label for="txtnombrecontacto" class="form-label">Nombre Contacto:</label>
                                            <input type="text" class="form-control form-control-sm" id="txtnombrecontacto" autocomplete="off" />
                                        </div>

                                        <div class="mb-2">
                                            <label for="txtdireccion" class="form-label">Dirección:</label>
                                            <input type="text" class="form-control form-control-sm" id="txtdireccion" autocomplete="off" />
                                        </div>

                                        <div class="mb-3">
                                            <label for="txttelefono" class="form-label">Teléfono:</label>
                                            <input type="text" class="form-control form-control-sm" id="txttelefono" autocomplete="off" />
                                        </div>

                                        <div class="d-grid">
                                            <button class="btn btn-success" type="button" onclick="RealizarPago()">
                                                <i class="fab fa-paypal"></i> Terminar y Procesar Pago
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div> <!-- /row -->
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
        $(document).ready(function () {
            cargarCarrito();
            ListarDepartamento();
            $.ajax({
                url: '@Url.Action("ListarProductosCarrito", "Tienda")',
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {

                    $("#productos-carrito").html("");
                    $("#productos-carrito").LoadingOverlay && $("#productos-carrito").LoadingOverlay("hide");

                    $.each(response.data, function (i, item) {

                        $("<div>").addClass("card mb-2 card-producto").append(
                            $("<div>").addClass("card-body").append(
                                $("<div>").addClass("row align-items-center").append(

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<img>").addClass("rounded")
                                            .attr({
                                                "src": "data:image/" + item.oProducto.Extension + ";base64," + item.oProducto.base64,
                                                "alt": item.oProducto.Nombre
                                            })
                                            .css({ "width": "100px", "height": "100px", "object-fit": "cover" })
                                    ),

                                    $("<div>").addClass("col-sm-4").append(
                                        $("<span>").addClass("fw-bold d-block").text(item.oProducto.oMarca.Descripcion),
                                        $("<span>").text(item.oProducto.Nombre)
                                    ),

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<span>").text(item.oProducto.Precio.toFixed(2) + " USD")
                                    ),

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<div>").addClass("input-group input-group-sm justify-content-center").append(
                                            $("<button>").addClass("btn btn-outline-secondary btn-restar")
                                                .append($("<i>").addClass("fas fa-minus")),
                                            $("<input>").addClass("form-control text-center p-1 input-cantidad")
                                                .attr({ "disabled": true })
                                                .css({ "max-width": "40px" })
                                                .data("oProducto", item.oProducto)
                                                .val(item.Cantidad),
                                            $("<button>").addClass("btn btn-outline-secondary btn-sumar")
                                                .append($("<i>").addClass("fas fa-plus"))
                                        )
                                    ),

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<button>").addClass("btn btn-outline-danger btn-eliminar")
                                            .append($("<i>").addClass("far fa-trash-alt me-1"))
                                            .append("Eliminar")
                                    )
                                )
                            )
                        ).appendTo("#productos-carrito");

                    });

                    sumarTotal();
                }
            });

            ListarDepartamento();
        });

        function cargarCarrito() {
            $.ajax({
                url: '@Url.Action("ListarProductosCarrito", "Tienda")',
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    $("#productos-carrito").empty();

                    $.each(response.data, function (i, item) {
                        $("<div>").addClass("card mb-2 card-producto").append(
                            $("<div>").addClass("card-body").append(
                                $("<div>").addClass("row align-items-center").append(

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<img>").addClass("rounded")
                                            .attr({
                                                "src": "data:image/" + item.oProducto.Extension + ";base64," + item.oProducto.base64,
                                                "alt": item.oProducto.Nombre
                                            })
                                            .css({ "width": "100px", "height": "100px", "object-fit": "cover" })
                                    ),

                                    $("<div>").addClass("col-sm-4").append(
                                        $("<span>").addClass("fw-bold d-block").text(item.oProducto.oMarca.Descripcion),
                                        $("<span>").text(item.oProducto.Nombre)
                                    ),

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<span>").text(item.oProducto.Precio.toFixed(2) + " USD")
                                    ),

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<div>").addClass("input-group input-group-sm justify-content-center").append(
                                            $("<button>").addClass("btn btn-outline-secondary btn-restar")
                                                .append($("<i>").addClass("fas fa-minus")),
                                            $("<input>").addClass("form-control text-center p-1 input-cantidad")
                                                .attr({ "disabled": true })
                                                .css({ "max-width": "40px" })
                                                .data("oProducto", item.oProducto)
                                                .val(item.Cantidad),
                                            $("<button>").addClass("btn btn-outline-secondary btn-sumar")
                                                .append($("<i>").addClass("fas fa-plus"))
                                        )
                                    ),

                                    $("<div>").addClass("col-sm-2 text-center").append(
                                        $("<button>").addClass("btn btn-outline-danger btn-eliminar")
                                            .append($("<i>").addClass("far fa-trash-alt me-1"))
                                            .append("Eliminar")
                                    )
                                )
                            )
                        ).appendTo("#productos-carrito");
                    });

                    sumarTotal();
                }
            });
        }

        /* ---------- UTILIDADES DE UBIGEO (sin cambios sustanciales) ---------- */

        function ListarDepartamento() {
            $("<option>").attr({ "value": "00", "disabled": true, "selected": true })
                .text("Seleccionar")
                .appendTo("#cbodepartamento");

            $.ajax({
                url: '@Url.Action("ObtenerDepartamento", "Tienda")',
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.lista) {
                        $.each(data.lista, function (i, item) {
                            $("<option>").val(item.IdDepartamento).text(item.Descripcion)
                                .appendTo("#cbodepartamento");
                        });
                    }
                }
            });
        }

        $("#cbodepartamento").on("change", function () {
            ListarProvincia();
        });

        function ListarProvincia() {
            $("#cboprovincia").html("");
            $("<option>").val("00").prop("selected", true).text("Seleccionar").appendTo("#cboprovincia");

            $.ajax({
                url: '@Url.Action("ObtenerProvincia", "Tienda")',
                type: "POST",
                data: JSON.stringify({ IdDepartamento: $("#cbodepartamento").val() }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.lista) {
                        $.each(data.lista, function (i, item) {
                            $("<option>").val(item.IdProvincia).text(item.Descripcion)
                                .appendTo("#cboprovincia");
                        });
                        ListarDistrito();
                    }
                }
            });
        }

        $("#cboprovincia").on("change", function () {
            ListarDistrito();
        });

        function ListarDistrito() {
            $("#cbodistrito").html("");
            $("<option>").val("00").prop("selected", true).text("Seleccionar").appendTo("#cbodistrito");

            $.ajax({
                url: '@Url.Action("ObtenerDistrito", "Tienda")',
                type: "POST",
                data: JSON.stringify({
                    IdDepartamento: $("#cbodepartamento").val(),
                    IdProvincia: $("#cboprovincia").val()
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.lista) {
                        $.each(data.lista, function (i, item) {
                            $("<option>").val(item.IdDistrito).text(item.Descripcion)
                                .appendTo("#cbodistrito");
                        });
                    }
                }
            });
        }

        /* ----------------------- SUMAR TOTAL ----------------------- */

        // Asegúrate de que esta función exista antes de llamarla
        function sumarTotal() {
            var sumaTotal = 0;
            $(".input-cantidad").each(function () {
                var producto = $(this).data("oProducto");
                if (producto) {
                    var precio = producto.Precio;
                    var cantidad = parseFloat($(this).val());
                    if (!isNaN(precio) && !isNaN(cantidad)) {
                        sumaTotal += precio * cantidad;
                    }
                }
            });
            $("#total").text(sumaTotal.toFixed(2));
            $("#total").data("sumatotal", sumaTotal);
        }

        /* --------------------- HANDLERS CARRITO --------------------- */

        // Sumar o restar
        $(document).on("click", ".btn-sumar, .btn-restar", function () {
            var card_producto = $(this).closest(".card-producto");
            var input_cantidad = card_producto.find(".input-cantidad");
            var producto = input_cantidad.data("oProducto");

            if (!producto) { console.error("No se encontró el producto asociado"); return; }

            var idproducto = producto.IdProducto;
            var sumar = $(this).hasClass("btn-sumar");

            $.ajax({
                url: '@Url.Action("OperacionCarrito", "Tienda")',
                type: "POST",
                data: JSON.stringify({ idproducto: idproducto, sumar: sumar }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.respuesta) {
                        if (sumar) {
                            input_cantidad.val(parseInt(input_cantidad.val()) + 1);
                        } else {
                            var nueva = parseInt(input_cantidad.val()) - 1;
                            if (nueva >= 1) {
                                input_cantidad.val(nueva);
                            } else {
                                // Si quedó en 0, remover del DOM
                                card_producto.remove();
                            }
                        }
                        sumarTotal();
                    } else {
                        Swal.fire("", data.mensaje || "No se pudo procesar.", "warning");
                    }
                },
                error: function (error) {
                    console.error("Error en la operación del carrito:", error);
                }
            });
        });

        // Eliminar
        $(document).on("click", ".btn-eliminar", function () {
            var card_producto = $(this).closest(".card-producto");
            var input_cantidad = card_producto.find(".input-cantidad");
            var producto = input_cantidad.data("oProducto");
            if (!producto) { console.error("No se encontró el producto asociado"); return; }

            var idproducto = producto.IdProducto;

            $.ajax({
                url: '@Url.Action("EliminarDeCarrito", "Tienda")',
                type: "POST",
                data: JSON.stringify({ idproducto: idproducto }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.respuesta) {
                        card_producto.remove();
                        sumarTotal();
                    } else {
                        Swal.fire("", data.mensaje || "No se pudo eliminar.", "warning");
                    }
                },
                error: function (error) {
                    console.error("Error al eliminar producto:", error);
                }
            });
        });

        function cargarCarrito() {
        $.ajax({
            url: '@Url.Action("ListarProductosCarrito", "Tienda")',
            type: "POST",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                $("#productos-carrito").empty();

                $.each(response.data, function (i, item) {

                    $("<div>").addClass("card mb-2 card-producto").append(
                        $("<div>").addClass("card-body").append(
                            $("<div>").addClass("row align-items-center").append(

                                $("<div>").addClass("col-sm-2 text-center").append(
                                    $("<img>").addClass("rounded")
                                        .attr({
                                            "src": "data:image/" + item.oProducto.Extension + ";base64," + item.oProducto.base64,
                                            "alt": item.oProducto.Nombre
                                        })
                                        .css({ "width": "100px", "height": "100px", "object-fit": "cover" })
                                ),

                                $("<div>").addClass("col-sm-4").append(
                                    $("<span>").addClass("fw-bold d-block").text(item.oProducto.oMarca.Descripcion),
                                    $("<span>").text(item.oProducto.Nombre)
                                ),

                                $("<div>").addClass("col-sm-2 text-center").append(
                                    $("<span>").text(item.oProducto.Precio.toFixed(2) + " USD")
                                ),

                                $("<div>").addClass("col-sm-2 text-center").append(
                                    $("<div>").addClass("input-group input-group-sm justify-content-center").append(
                                        $("<button>").addClass("btn btn-outline-secondary btn-restar")
                                            .append($("<i>").addClass("fas fa-minus")),
                                        $("<input>").addClass("form-control text-center p-1 input-cantidad")
                                            .attr({ "disabled": true })
                                            .css({ "max-width": "40px" })
                                            .data("oProducto", item.oProducto)
                                            .val(item.Cantidad),
                                        $("<button>").addClass("btn btn-outline-secondary btn-sumar")
                                            .append($("<i>").addClass("fas fa-plus"))
                                    )
                                ),

                                $("<div>").addClass("col-sm-2 text-center").append(
                                    $("<button>").addClass("btn btn-outline-danger btn-eliminar")
                                        .append($("<i>").addClass("far fa-trash-alt me-1"))
                                        .append("Eliminar")
                                )
                            )
                        )
                    ).appendTo("#productos-carrito");
                });

                sumarTotal();
            }
        });
    }

    function RealizarPago() {

    if (parseInt($("#cantidadcarrito").text()) == 0) {
        swal("", "No existe productos en el carrito", "warning");
        return;
    }

    if ($("#cbodistrito").val() == null || $("#txtnombrecontacto").val() == "" || $("#txtdireccion").val() == "" || $("#txttelefono").val() == "") {
        swal("", "Debe completar los datos de detalle envío", "warning");
        return;
    }

    var venta = {
        TotalProducto: $("input.input-cantidad").length,
        MontoTotal: 0,
        Contacto: $("#txtnombrecontacto").val(),
        IdDistrito: $("#cbodistrito").val(),
        Telefono: $("#txttelefono").val(),
        Direccion: $("#txtdireccion").val()
    };

    var lista_carrito = [];

    $("input.input-cantidad").each(function (i) {

        var producto = $(this).data("oProducto");
        var cantidad = parseFloat($(this).val());

        lista_carrito.push({
            oProducto: producto,
            Cantidad: cantidad
        });
    });

    jQuery.ajax({
        url: '@Url.Action("ProcesarPago", "Tienda")',
        type: "POST",
        data: JSON.stringify({ oListaCarrito: lista_carrito, oVenta: venta }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {

            $.LoadingOverlay("hide");

            if (data.Status) {
                window.location.href = data.Link;
            } else {
                swal("", "Vuelva a intentarlo más tarde", "warning");
            }
        },
        beforeSend: function () { $.LoadingOverlay("show"); },
        error: function (error) { $.LoadingOverlay("hide"); }
    });
}
</script>
}}

